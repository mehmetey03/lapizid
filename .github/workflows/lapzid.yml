name: Dizipal M3U Scraper

on:
  schedule:
    # Her gÃ¼n saat 03:00'te Ã§alÄ±ÅŸtÄ±r (UTC)
    - cron: '0 3 * * *'
  # Manuel tetikleme iÃ§in
  workflow_dispatch:
  # Main branch'e push yapÄ±ldÄ±ÄŸÄ±nda
  push:
    branches: [ main ]
    paths:
      - 'dizipal_scraper.py'

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ›ï¸ Repoyu Checkout et
      uses: actions/checkout@v4
      with:
        # DeÄŸiÅŸiklikleri commit edebilmek iÃ§in token
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Python kurulumu
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ Gerekli kÃ¼tÃ¼phaneleri yÃ¼kle
      run: |
        pip install cloudscraper beautifulsoup4 requests lxml
    
    - name: ğŸš€ Dizipal scraper'Ä± Ã§alÄ±ÅŸtÄ±r
      run: |
        python dizipal_scraper.py
      continue-on-error: true
    
    - name: ğŸ“ OluÅŸan dosyalarÄ± kontrol et
      run: |
        echo "ğŸ“‚ Mevcut dosyalar:"
        ls -la
        echo ""
        echo "ğŸ“Š M3U dosyasÄ± boyutu:"
        if [ -f "dizipal_filmler.m3u" ]; then
          wc -l dizipal_filmler.m3u
          # Ä°lk 5 satÄ±rÄ± gÃ¶ster
          head -10 dizipal_filmler.m3u
        else
          echo "âŒ dizipal_filmler.m3u bulunamadÄ±!"
          echo "ğŸ—‘ï¸ Test dosyalarÄ±nÄ± kontrol et:"
          ls -la *.m3u
        fi
    
    - name: âœï¸ Git kullanÄ±cÄ±sÄ±nÄ± ayarla
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: ğŸ“¤ DeÄŸiÅŸiklikleri kontrol et ve push yap
      run: |
        echo "ğŸ”„ DeÄŸiÅŸiklikleri kontrol ediyorum..."
        
        # M3U dosyasÄ±nÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et
        if [ ! -f "dizipal_filmler.m3u" ]; then
          echo "âš ï¸ dizipal_filmler.m3u bulunamadÄ±, test modu Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
          # Test modunda Ã§alÄ±ÅŸtÄ±r
          python dizipal_scraper.py
        fi
        
        # DeÄŸiÅŸiklik olup olmadÄ±ÄŸÄ±nÄ± kontrol et
        git status
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "âœ… DeÄŸiÅŸiklik yok"
        else
          echo "ğŸ“ Yeni deÄŸiÅŸiklikler var, commit yapÄ±lÄ±yor..."
          
          # TÃ¼m deÄŸiÅŸiklikleri ekle
          git add .
          
          # Commit mesajÄ± oluÅŸtur
          COMMIT_DATE=$(date +"%Y-%m-%d %H:%M:%S")
          COMMIT_MSG="ğŸ¤– Otomatik gÃ¼ncelleme: $COMMIT_DATE"
          
          # Commit yap
          git commit -m "$COMMIT_MSG"
          
          # Push yap
          git push
          
          echo "âœ… DeÄŸiÅŸiklikler push edildi"
        fi
      env:
        # GitHub token'Ä± kullan
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
