name: Dizipal M3U Scraper

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: ğŸ›ï¸ Repoyu Checkout et
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Python kurulumu
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: ğŸŒ Chrome kurulumu (Selenium iÃ§in)
      run: |
        sudo apt-get update
        sudo apt-get install -y chromium-browser chromium-chromedriver
    
    - name: ğŸ“¦ Gerekli kÃ¼tÃ¼phaneleri yÃ¼kle
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸš€ Dizipal scraper'Ä± Ã§alÄ±ÅŸtÄ±r
      run: python dizipal_scraper.py
    
    - name: ğŸ“Š SonuÃ§larÄ± kontrol et
      run: |
        echo "ğŸ“‚ Dosya listesi:"
        ls -la *.m3u
        
        if [ -f "dizipal_filmler.m3u" ]; then
          echo "âœ… dizipal_filmler.m3u bulundu"
          echo "ğŸ“ˆ SatÄ±r sayÄ±sÄ±: $(wc -l < dizipal_filmler.m3u)"
          echo "ğŸ“¦ Dosya boyutu: $(wc -c < dizipal_filmler.m3u) bytes"
          echo ""
          echo "ğŸ“‹ Ä°lk 10 satÄ±r:"
          head -10 dizipal_filmler.m3u
          
          # Eski dizipal.m3u'yu sil
          rm -f dizipal.m3u
        else
          echo "âŒ dizipal_filmler.m3u bulunamadÄ±!"
          exit 1
        fi
    
    - name: âœï¸ Git kullanÄ±cÄ±sÄ±nÄ± ayarla
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
    
    - name: ğŸ“¤ DeÄŸiÅŸiklikleri push et
      run: |
        echo "ğŸ”„ DeÄŸiÅŸiklikler kontrol ediliyor..."
        
        # DeÄŸiÅŸiklik olup olmadÄ±ÄŸÄ±nÄ± kontrol et
        if [ -z "$(git status --porcelain)" ]; then
          echo "âœ… DeÄŸiÅŸiklik yok"
        else
          echo "ğŸ“ Yeni deÄŸiÅŸiklikler var"
          
          git status
          git add .
          
          COMMIT_DATE=$(date +"%Y-%m-%d %H:%M:%S")
          if [ -f "dizipal_filmler.m3u" ]; then
            LINE_COUNT=$(wc -l < dizipal_filmler.m3u)
            COMMIT_MSG="ğŸ¤– M3U gÃ¼ncellendi ($LINE_COUNT satÄ±r) - $COMMIT_DATE"
          else
            COMMIT_MSG="ğŸ¤– Otomatik gÃ¼ncelleme - $COMMIT_DATE"
          fi
          
          git commit -m "$COMMIT_MSG"
          git push
          
          echo "âœ… DeÄŸiÅŸiklikler push edildi"
        fi
